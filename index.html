<html>
  <head>
  <script>
    var SPEED = 10;
    
    class Player {

      constructor(colour) {
        this.colour = colour;
        this.memory = {}; // States => Options
        this.history = []; // of [State, Move]
      }

      playMove(game) {
        var curState = game.stateString();
        var options = this.getOptions(curState, game);
        var item = this.pickOptions(options);
        //Remember Move Taken
        this.history.push([curState, item]);

        game.play(this.colour, item);
      }

      pickOptions(options) {
        return options[Math.floor(Math.random()*options.length)];
      }

      getOptions(curState, game) {
        if(this.memory[curState] === undefined) {
          this.memory[curState] = game.moves();
        } else {
          console.log("Use Memory!");
        }
        return this.memory[curState];
      }

      learnFromWin() {
        for(var m in this.history) {
          var move = this.history[m];
          var state = move[0];
          var col = move[1];
          //Strengthen option taken for state
          this.memory[state].push(col);
        }
      }

    }


    class Game {
      constructor() {
        this.board = []
        for(var r = 0; r <6; r++) {
          var row = []
          for(var c = 0; c < 7; c++) {
            row.push(".")
          }
          this.board.push(row);
        }
      }

      stateString() {
        return this.board.join(":");
      }


      showWinner() {
        var names = {"r": "Red", "y": "Yellow"};
        var info = document.getElementById("info");
        info.innerHTML = "Winner is " + names[this.winner];
      }

      render() {
        var grid = document.createElement("TABLE");
        for(var r in this.board) {
          var row = this.board[r];
          var rowElem = document.createElement("TR");
          for(var c in row) {
            var cell = row[c];
            var cellElem = document.createElement("TD");
            cellElem.className = cell;
            rowElem.appendChild(cellElem);
          }
          grid.appendChild(rowElem);
        }
        var board = document.getElementById("board");
        var newBoard = document.createElement("DIV");
        newBoard.appendChild(grid);
        board.replaceWith(newBoard);
        newBoard.id = "board";
      }

      play(colour, col) {
        if(this.board[5][col] == ".") {
          this.board[5][col] = colour;
        } else {
          for(var r = 0; r < 5; r++) {
            if(this.board[r+1][col] != ".") {
              this.board[r][col] = colour;
              break;
            }
          }
        }
      }

      moves() {
        var options = [];
        var top = this.board[0];
        for(var c in top) {
          if(top[c] == ".") {
            options.push(c);
          }
        }
        return options;
      }

      isOver() {
        // Any Horiz 4 in a row?
        for(var r in this.board) {
          var seq = 1;
          var cur = "?";
          for(var c in this.board[r]) {
            var cell = this.board[r][c];
            if(cell == cur && cell != ".") {
              seq += 1;
              if(seq == 4) {
                this.winner = cell;
                return true;
              }
            } else {
              seq = 1;
              cur = cell;
            }
          }
        }
        // Any Vertical 4 in a row?
        for(var c = 0; c < 7; c++) {
          var seq = 1;
          var cur = "?";
          for(var r = 0; r < 6; r++) {
            var cell = this.board[r][c];
            if(cell == cur && cell != ".") {
              seq += 1;
              if(seq == 4) {
                this.winner = cell;
                return true;
              }
            } else {
              seq = 1;
              cur = cell;
            }
          }
        }

        //Any From Left Diagonal 4 in a row?
        for(var c = 0; c <=3 ; c++) {
          for(var r = 0; r <=2; r++) {
            var cell = this.board[r][c];
            if(cell != "." && 
              (this.board[r+1][c+1] == cell) &&
              (this.board[r+2][c+2] == cell) &&
              (this.board[r+3][c+3] == cell)) {
              this.winner = cell;
              return true;
            }
          }
        }
        //Any From Right Diagonal 4 in a row?
        for(var c = 3; c <=6 ; c++) {
          for(var r = 0; r <=2; r++) {
            var cell = this.board[r][c];
            if(cell != "." && 
              (this.board[r+1][c-1] == cell) &&
              (this.board[r+2][c-2] == cell) &&
              (this.board[r+3][c-3] == cell)) {
              this.winner = cell;
              return true;
            }
          }
        }
      }
    }

    game = new Game();
    players = [
      new Player("r"),
      new Player("y")
    ];
    currentPlayer = 0;

    function playGame() {
      if(game.isOver()) {
        game.showWinner();
        var winner;
        if(players[0].colour == game.winner) {
          //0 Won
          winner = players[0];
        } else {
          //1 Won
          winner = players[1];
        }
        winner.learnFromWin();
      } else {
        player = players[currentPlayer];
        player.playMove(game);
        currentPlayer = 1 - currentPlayer;
        setTimeout('playGame()', SPEED);
        game.render();
      }
    }

    document.addEventListener('DOMContentLoaded', function(){
      setTimeout('playGame()', SPEED);
    });
  </script>
  <style>
    #board table {
      border: 1px solid black;
      background-color: blue;
    }
    #board table tr {
      padding: 0;
      margin: 0;
    }

    #board table td {
      padding: 0;
      margin: 0;
      border: 1px solid black;
      width: 12px;
      height: 12px;
      background-color: #ddd;
    }

    #board table td.r {
      background-color: red;
    }

    #board table td.y {
      background-color: yellow;
    }
  </style>
  </head>
  <body>
    <div id='board'><span/></div>
    <div id='info'>
    </div>
  </body>
</html>
